<!DOCTYPE html>
<html>
<head>
  <title>Faculty Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#3b6cb7',
            'primary-hover': '#3458a2'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Faculty Dashboard</h1>
        <p class="text-lg font-medium text-gray-600" id="faculty-welcome">Welcome back, Demo Faculty</p>
      </div>
      <div class="flex items-center gap-4">
        <!-- Faculty Selector (for testing purposes) -->
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Faculty:</label>
          <select id="faculty-selector" onchange="changeFaculty()" class="px-3 py-1 border border-gray-300 rounded text-sm">
            <option value="2">Dr. John Smith (ID: 2)</option>
            <option value="3">Dr. Jane Doe (ID: 3)</option>
          </select>
        </div>
        <button onclick="logout()" class="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Alert Messages -->
    <div id="alert-success" class="hidden mb-6 px-4 py-3 rounded-lg text-green-800 bg-green-100 border border-green-300"></div>
    <div id="alert-error" class="hidden mb-6 px-4 py-3 rounded-lg text-red-800 bg-red-100 border border-red-300"></div>

    <!-- Your Classes Section -->
    <div id="classes-section" class="bg-white rounded-xl shadow-md border border-gray-200 p-8">
      <div class="flex items-center mb-6">
        <svg class="w-6 h-6 mr-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path>
        </svg>
        <h2 class="text-2xl font-bold text-gray-900">Your Classes</h2>
      </div>
      <p class="text-lg text-gray-600 mb-8">Click on a class to create and manage exams</p>
      
      <div id="classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="text-center py-8 text-gray-500 text-lg">Loading classes...</div>
      </div>
    </div>

    <!-- Create Exam Section -->
    <div id="create-exam-section" class="hidden bg-white rounded-xl shadow-md border border-gray-200 p-8">
      <div class="flex items-center mb-6">
        <button onclick="backToClasses()" class="mr-4 p-2 text-gray-600 hover:text-gray-800 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h2 class="text-2xl font-bold text-gray-900">Create New Exam</h2>
      </div>

      <!-- Exam Form -->
      <form id="exam-form" class="space-y-6">
        <input type="hidden" id="selected_subject_id">
        <input type="hidden" id="selected_year_level">
        <input type="hidden" id="selected_section">
        
        <!-- Exam Details -->
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Exam Details</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Exam Title</label>
              <input type="text" id="exam_title" placeholder="e.g. Midterm Examination" required 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none text-lg">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
              <textarea id="exam_instructions" placeholder="Enter exam instructions for students..." rows="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none text-lg resize-vertical"></textarea>
            </div>
          </div>
        </div>

        <!-- Class Information -->
        <div class="bg-blue-50 p-4 rounded-lg border-b border-gray-200 pb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Class Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div>
              <p class="text-sm font-medium text-gray-600">Subject</p>
              <p id="display_subject" class="text-lg font-bold text-gray-900">-</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Year Level</p>
              <p id="display_year" class="text-lg font-bold text-gray-900">-</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Section</p>
              <p id="display_section" class="text-lg font-bold text-gray-900">-</p>
            </div>
          </div>
        </div>

        <!-- Questions Section -->
        <div>
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Questions (<span id="question-count">0</span>)</h3>
            <button type="button" onclick="showAddQuestion()" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Add Question
            </button>
          </div>

          <!-- Questions List -->
          <div id="questions-list" class="space-y-4 mb-6">
            <div class="text-center py-8 text-gray-500">No questions added yet. Click "Add Question" to start.</div>
          </div>

          <!-- Add Question Form -->
          <div id="add-question-form" class="hidden bg-gray-50 p-6 rounded-lg border">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Add New Question</h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                <select id="question_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:border-primary focus:outline-none">
                  <option value="multiple_choice">Multiple Choice</option>
                  <option value="true_false">True/False</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                <textarea id="question_text" placeholder="Enter your question here..." rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none resize-vertical" required></textarea>
              </div>

              <!-- Multiple Choice Options -->
              <div id="mc-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Option A</label>
                  <input type="text" id="option_a" placeholder="Option A" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Option B</label>
                  <input type="text" id="option_b" placeholder="Option B" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Option C</label>
                  <input type="text" id="option_c" placeholder="Option C" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Option D</label>
                  <input type="text" id="option_d" placeholder="Option D" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                </div>
              </div>

              <!-- True/False Options -->
              <div id="tf-options" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                <select id="tf_answer" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:border-primary focus:outline-none">
                  <option value="True">True</option>
                  <option value="False">False</option>
                </select>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer</label>
                  <select id="correct_answer" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:border-primary focus:outline-none">
                    <option value="">Select correct answer</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                  <input type="number" id="question_points" value="1" min="1" 
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                </div>
              </div>

              <div class="flex gap-4">
                <button type="button" onclick="addQuestion()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors font-medium">
                  Add Question
                </button>
                <button type="button" onclick="cancelAddQuestion()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Exam -->
        <div class="pt-6 border-t border-gray-200">
          <div class="flex gap-4">
            <button type="submit" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-lg">
              Create Exam
            </button>
            <button type="button" onclick="backToClasses()" class="px-8 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-semibold text-lg">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global variables
    let facultyId = 2; // Default faculty ID, can be changed for testing
    let currentQuestions = [];
    let editingQuestionIndex = -1;
    let debugMode = true; // Enable debugging

    // Utility functions
    function showAlert(message, type = 'success') {
      const alertId = type === 'success' ? 'alert-success' : 'alert-error';
      const alertElement = document.getElementById(alertId);
      
      document.getElementById('alert-success').classList.add('hidden');
      document.getElementById('alert-error').classList.add('hidden');
      
      alertElement.textContent = message;
      alertElement.classList.remove('hidden');
      
      setTimeout(() => {
        alertElement.classList.add('hidden');
      }, 5000);
    }

    // Debug logging
    function debugLog(message, data = null) {
      if (debugMode) {
        console.log('[Faculty Dashboard Debug]', message, data);
      }
    }

    // Load faculty classes with enhanced debugging
    async function loadClasses() {
      try {
        debugLog('Loading classes for faculty ID:', facultyId);
        
        // First try the debug API to get detailed information
        const debugRes = await fetch(`api/debug_faculty_subjects.php?faculty_id=${facultyId}`);
        const debugData = await debugRes.json();
        
        debugLog('Debug API response:', debugData);
        
        if (debugData.error) {
          showAlert('Debug Error: ' + debugData.error, 'error');
          console.error('Debug data:', debugData.debug);
          return;
        }
        
        // Check if database is properly set up
        if (debugData.debug.total_faculty_users === 0) {
          showAlert('No faculty users found in database. Please run setup_database.php first.', 'error');
          return;
        }
        
        if (debugData.debug.total_subjects === 0) {
          showAlert('No subjects found in database. Please run setup_database.php first.', 'error');
          return;
        }
        
        if (debugData.debug.total_assignments === 0) {
          showAlert('No subject assignments found in database. Please run setup_database.php first.', 'error');
          return;
        }
        
        if (!debugData.debug.faculty_exists) {
          showAlert(`Faculty with ID ${facultyId} does not exist. Available faculty: ${debugData.debug.faculty_users.map(f => `${f.user_id}: ${f.full_name}`).join(', ')}`, 'error');
          return;
        }
        
        // Use the subjects from debug response
        const classes = debugData.subjects;
        
        const container = document.getElementById('classes-container');
        if (!classes || classes.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-center py-8 text-gray-500 text-lg">
              <p>No classes assigned to this faculty member yet.</p>
              <p class="text-sm mt-2">Faculty: ${debugData.debug.faculty_data.full_name}</p>
              <p class="text-sm">Available assignments in database: ${debugData.debug.total_assignments}</p>
              <button onclick="showDebugInfo()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">Show Debug Info</button>
            </div>
          `;
          return;
        }

        debugLog('Successfully loaded classes:', classes);

        container.innerHTML = classes.map(classInfo => `
          <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer"
               onclick="selectClass('${classInfo.subject_id}', '${classInfo.subject_name}', '${classInfo.course_code}', '${classInfo.year_level}', '${classInfo.section}')">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-gray-900">${classInfo.subject_name}</h3>
                <p class="text-gray-600 font-medium">${classInfo.course_code}</p>
              </div>
              <span class="text-sm font-medium text-gray-500">${classInfo.year_level}${getOrdinalSuffix(classInfo.year_level)} Year - ${classInfo.section}</span>
            </div>
            
            <div class="flex justify-between items-center">
              <div class="flex items-center text-gray-600">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="text-sm">${classInfo.exam_count || 0} exams</span>
              </div>
              <button class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Create Exam
              </button>
            </div>
          </div>
        `).join('');
        
        showAlert(`Successfully loaded ${classes.length} class(es)`, 'success');
        
      } catch (error) {
        debugLog('Error loading classes:', error);
        showAlert('Failed to load classes: ' + error.message, 'error');
        
        // Show fallback message with helpful information
        const container = document.getElementById('classes-container');
        container.innerHTML = `
          <div class="col-span-full text-center py-8 text-red-500 text-lg">
            <p>Error loading classes: ${error.message}</p>
            <p class="text-sm mt-2">Please check:</p>
            <ul class="text-sm text-left inline-block mt-2">
              <li>1. Database is running (MySQL)</li>
              <li>2. Database 'capstone' exists</li>
              <li>3. Run setup_database.php to initialize data</li>
              <li>4. Check browser console for details</li>
            </ul>
            <button onclick="loadClasses()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">Retry</button>
          </div>
        `;
      }
    }

    // Show debug information
    function showDebugInfo() {
      fetch(`api/debug_faculty_subjects.php?faculty_id=${facultyId}`)
        .then(res => res.json())
        .then(data => {
          console.log('=== FACULTY DASHBOARD DEBUG INFO ===');
          console.log('Faculty ID:', facultyId);
          console.log('Debug Data:', data);
          alert('Debug information logged to browser console (F12). Check the Console tab.');
        })
        .catch(err => {
          console.error('Debug request failed:', err);
          alert('Debug request failed. Check browser console for details.');
        });
    }

    // Change faculty for testing purposes
    function changeFaculty() {
      const selector = document.getElementById('faculty-selector');
      const selectedId = parseInt(selector.value);
      facultyId = selectedId;
      
      // Update welcome message
      const facultyNames = {
        2: 'Dr. John Smith',
        3: 'Dr. Jane Doe'
      };
      
      const welcomeElement = document.getElementById('faculty-welcome');
      welcomeElement.textContent = `Welcome back, ${facultyNames[selectedId]}`;
      
      debugLog('Faculty changed to:', { id: facultyId, name: facultyNames[selectedId] });
      
      // Reload classes for the new faculty
      loadClasses();
      
      // Hide exam creation section if open
      backToClasses();
    }

    function getOrdinalSuffix(num) {
      const suffixes = { 1: 'st', 2: 'nd', 3: 'rd' };
      return suffixes[num] || 'th';
    }

    // Class selection
    function selectClass(subjectId, subjectName, courseCode, yearLevel, section) {
      document.getElementById('selected_subject_id').value = subjectId;
      document.getElementById('selected_year_level').value = yearLevel;
      document.getElementById('selected_section').value = section;
      
      document.getElementById('display_subject').textContent = `${subjectName} (${courseCode})`;
      document.getElementById('display_year').textContent = `${yearLevel}${getOrdinalSuffix(yearLevel)} Year`;
      document.getElementById('display_section').textContent = section;
      
      document.getElementById('classes-section').classList.add('hidden');
      document.getElementById('create-exam-section').classList.remove('hidden');
      
      currentQuestions = [];
      updateQuestionsList();
    }

    function backToClasses() {
      document.getElementById('create-exam-section').classList.add('hidden');
      document.getElementById('classes-section').classList.remove('hidden');
      document.getElementById('exam-form').reset();
      currentQuestions = [];
      hideAddQuestion();
    }

    // Question management
    function showAddQuestion() {
      document.getElementById('add-question-form').classList.remove('hidden');
      document.getElementById('question_type').onchange = toggleQuestionType;
      toggleQuestionType();
    }

    function hideAddQuestion() {
      document.getElementById('add-question-form').classList.add('hidden');
      clearQuestionForm();
    }

    function cancelAddQuestion() {
      hideAddQuestion();
      editingQuestionIndex = -1;
    }

    function toggleQuestionType() {
      const type = document.getElementById('question_type').value;
      const mcOptions = document.getElementById('mc-options');
      const tfOptions = document.getElementById('tf-options');
      const correctAnswer = document.getElementById('correct_answer');
      
      if (type === 'multiple_choice') {
        mcOptions.classList.remove('hidden');
        tfOptions.classList.add('hidden');
        correctAnswer.classList.remove('hidden');
        correctAnswer.parentElement.classList.remove('hidden');
      } else {
        mcOptions.classList.add('hidden');
        tfOptions.classList.remove('hidden');
        correctAnswer.classList.add('hidden');
        correctAnswer.parentElement.classList.add('hidden');
      }
    }

    function addQuestion() {
      const type = document.getElementById('question_type').value;
      const text = document.getElementById('question_text').value.trim();
      const points = parseInt(document.getElementById('question_points').value) || 1;
      
      if (!text) {
        showAlert('Question text is required', 'error');
        return;
      }
      
      let question = {
        type: type,
        text: text,
        points: points
      };
      
      if (type === 'multiple_choice') {
        const optionA = document.getElementById('option_a').value.trim();
        const optionB = document.getElementById('option_b').value.trim();
        const optionC = document.getElementById('option_c').value.trim();
        const optionD = document.getElementById('option_d').value.trim();
        const correct = document.getElementById('correct_answer').value;
        
        if (!optionA || !optionB || !optionC || !optionD || !correct) {
          showAlert('All options and correct answer are required for multiple choice questions', 'error');
          return;
        }
        
        question.options = { A: optionA, B: optionB, C: optionC, D: optionD };
        question.correct_answer = correct;
      } else {
        question.correct_answer = document.getElementById('tf_answer').value;
      }
      
      if (editingQuestionIndex >= 0) {
        currentQuestions[editingQuestionIndex] = question;
        editingQuestionIndex = -1;
      } else {
        currentQuestions.push(question);
      }
      
      updateQuestionsList();
      hideAddQuestion();
      showAlert('Question added successfully');
    }

    function updateQuestionsList() {
      const container = document.getElementById('questions-list');
      const count = document.getElementById('question-count');
      
      count.textContent = currentQuestions.length;
      
      if (currentQuestions.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No questions added yet. Click "Add Question" to start.</div>';
        return;
      }
      
      container.innerHTML = currentQuestions.map((q, index) => `
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <span class="text-sm font-medium text-gray-500 mr-2">Question ${index + 1}</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${q.type.replace('_', ' ')}</span>
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded ml-2">${q.points} pts</span>
              </div>
              <p class="text-gray-900 font-medium">${q.text}</p>
              ${q.type === 'multiple_choice' ? `
                <div class="mt-2 text-sm text-gray-600">
                  <div>A. ${q.options.A}</div>
                  <div>B. ${q.options.B}</div>
                  <div>C. ${q.options.C}</div>
                  <div>D. ${q.options.D}</div>
                  <div class="mt-1"><strong>Correct: ${q.correct_answer}</strong></div>
                </div>
              ` : `
                <div class="mt-2 text-sm text-gray-600">
                  <strong>Correct Answer: ${q.correct_answer}</strong>
                </div>
              `}
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="editQuestion(${index})" class="p-2 text-blue-600 hover:bg-blue-50 rounded">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button onclick="deleteQuestion(${index})" class="p-2 text-red-600 hover:bg-red-50 rounded">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function editQuestion(index) {
      const question = currentQuestions[index];
      editingQuestionIndex = index;
      
      document.getElementById('question_type').value = question.type;
      document.getElementById('question_text').value = question.text;
      document.getElementById('question_points').value = question.points;
      
      if (question.type === 'multiple_choice') {
        document.getElementById('option_a').value = question.options.A;
        document.getElementById('option_b').value = question.options.B;
        document.getElementById('option_c').value = question.options.C;
        document.getElementById('option_d').value = question.options.D;
        document.getElementById('correct_answer').value = question.correct_answer;
      } else {
        document.getElementById('tf_answer').value = question.correct_answer;
      }
      
      toggleQuestionType();
      showAddQuestion();
    }

    function deleteQuestion(index) {
      if (confirm('Are you sure you want to delete this question?')) {
        currentQuestions.splice(index, 1);
        updateQuestionsList();
        showAlert('Question deleted successfully');
      }
    }

    function clearQuestionForm() {
      document.getElementById('question_text').value = '';
      document.getElementById('option_a').value = '';
      document.getElementById('option_b').value = '';
      document.getElementById('option_c').value = '';
      document.getElementById('option_d').value = '';
      document.getElementById('correct_answer').value = '';
      document.getElementById('question_points').value = '1';
    }

    // Exam submission
    document.getElementById('exam-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const title = document.getElementById('exam_title').value.trim();
      const instructions = document.getElementById('exam_instructions').value.trim();
      const subjectId = document.getElementById('selected_subject_id').value;
      const yearLevel = document.getElementById('selected_year_level').value;
      const section = document.getElementById('selected_section').value;
      
      if (!title) {
        showAlert('Exam title is required', 'error');
        return;
      }
      
      if (currentQuestions.length === 0) {
        showAlert('At least one question is required', 'error');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('instructions', instructions);
        formData.append('subject_id', subjectId);
        formData.append('year_level', yearLevel);
        formData.append('section', section);
        formData.append('created_by', facultyId);
        formData.append('questions', JSON.stringify(currentQuestions));
        
        const res = await fetch('api/create_exam.php', {
          method: 'POST',
          body: formData
        });
        
        const result = await res.json();
        
        if (result.success) {
          showAlert('Exam created successfully!');
          setTimeout(() => {
            backToClasses();
            loadClasses(); // Refresh the classes to update exam count
          }, 2000);
        } else {
          showAlert(result.message || 'Failed to create exam', 'error');
        }
      } catch (error) {
        showAlert('Network error: ' + error.message, 'error');
      }
    });

    // Logout function
    async function logout() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await fetch('api/logout.php');
          window.location.href = 'login.html';
        } catch (error) {
          showAlert('Logout failed: ' + error.message, 'error');
        }
      }
    }

    // Initialize
    window.onload = () => {
      // Set initial faculty name
      changeFaculty();
      
      // Load classes
      loadClasses();
    };
  </script>
</body>
</html>